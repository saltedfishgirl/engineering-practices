# 小CL

## 为什么要写小CL？{＃为什么}

小而简单的CL是：

- 评论更快。审阅者更容易找到五次分钟来审查小型CL，而不是留出30分钟的时间来审查一个大型CL。
- 评论更彻底。随着大的变化，审稿人和作者往往会因为大量详细的评论来回变换而感到沮丧 - 有时甚至到了重要点被遗漏或丢失的程度。
- 不太可能引入错误。由于您进行的更改较少，因此您和您的审阅者可以更轻松地有效地推断CL的影响，并查看是否已引入错误。
- 如果被拒绝，减少浪费的工作。如果你写了一个巨大的CL然后你的评论者说整体方向是错误的，你就浪费了很多工作。
- 更容易合并。处理大型CL需要很长时间，因此在合并时会出现很多冲突，并且必须经常合并。
- 设计更容易。抛光一个小变化的设计和代码健康状况比完善一个大变化的所有细节要容易得多。
- 减少对评论的阻碍。发送整体更改的自包含部分可让您在等待当前CL审核时继续编码。
- 更简单的回滚。大型CL更有可能触及在初始CL提交和回滚CL之间更新的文件，从而使回滚变得复杂（中间的CL也可能需要回滚）。

请注意，审稿人可以自行决定完全拒绝您的更改，原因只是因为它太大。通常他们会感谢您的贡献，但要求您以某种方式将其变为一系列较小的变化。在您编写完变更后，或者需要花费大量时间来讨论为什么审阅者应该接受您的大变更，这可能需要做很多工作。首先编写小型CL更容易。

## 什么是小？{} #what_is_small
一般来说，CL的正确大小是一个独立的变化。这意味着：

- CL进行了一项最小的更改，只解决了一件事。这通常只是功能的一部分，而不是一次完整的功能。一般来说，最好是在编写过小的CL而不是过大的CL时犯错误。与您的审阅者合作，找出可接受的大小。
- 审阅者需要了解的关于CL的所有内容（除了未来的开发）都在CL，CL的描述，现有的代码库或他们已经审查过的CL中。
- 在签入CL后，系统将继续为其用户和开发人员提供良好的工作。
- CL不是那么小，其含义难以理解。如果您添加新API，则应在同一CL中包含API的使用，以便审阅者可以更好地了解API的使用方式。这也可以防止检查未使用的API。
关于有多大“太大”没有严格的规则。对于CL来说，100行通常是合理的大小，1000行通常太大，但这取决于您的评论者的判断。更改分散的文件数也会影响其“大小”。一个文件中的200行更改可能没问题，但是分布在50个文件中通常会太大。

请记住，尽管从开始编写代码开始就已经密切参与了代码，但审阅者通常没有上下文。对你来说，看起来像是一个可接受的大小的CL对你的评论家来说可能是压倒性的。如有疑问，请编写比您认为需要编写的小的CL。审稿人很少抱怨获得太小的CL。

## 什么时候大CL好吗？{} #large_okay

在某些情况下，大的变化并不那么糟糕：

您通常可以将整个文件的删除视为一行更改，因为审阅者不需要很长时间才能查看。
有时，您完全信任的自动重构工具生成了大型CL，审阅者的工作只是进行健全性检查，并说他们确实想要进行更改。尽管上面的一些警告（例如合并和测试）仍然适用，但这些CL可能更大。

### 按文件拆分{＃splitting-files}
拆分CL的另一种方法是对文件进行分组，这些文件需要不同的审阅者，否则就是自包含的更改。

例如：您发送一个CL以修改协议缓冲区，另一个CL发送更改使用该原型的代码。您必须在代码CL之前提交proto CL，但它们都可以同时进行查看。如果这样做，您可能希望通知两组审阅者您编写的其他CL，以便他们具有您的更改的上下文。

另一个例子：你发送一个CL用于代码更改，另一个用于使用该代码的配置或实验; 如果需要，这也更容易回滚，因为配置/实验文件有时会比代码更改更快地推向生产。


## 分离出重构{#refactoring}
通常最好在功能更改或错误修复的单独CL中进行重构。例如，移动和重命名类应该与修复该类中的错误的CL不同。审阅者更容易理解每​​个CL在单独时引入的更改。

但是，修复本地变量名称等小清理可以包含在功能更改或错误修复CL中。这取决于开发人员和审核人员的判断，以确定重构何时如此大，以至于如果包含在您当前的CL中，将使审核更加困难。

## 将相关的测试代码保存在同一个CL {#test_code}中
避免将测试代码拆分为单独的CL。验证代码修改的测试应该进入相同的CL，即使它增加了代码行数。

但是，独立的测试修改可以首先进入单独的CL，类似于重构指南。那包括：

- 使用新测试验证预先存在的已提交代码。
- 重构测试代码（例如引入辅助函数）。
- 引入更大的测试框架代码（例如集成测试）。


## 不要破坏构建{#break}
如果你有几个相互依赖的CL，你需要找到一种方法来确保在提交每个CL后整个系统继续工作。否则，您可能会在CL提交之间的几分钟内破坏所有开发人员的构建（如果您的后续CL提交出现意外情况，则可能更长）。

## 不能让它足够小{#cant}

有时你会遇到情况下好像你的CL 拥有大。这很少是真的。练习编写小型CL的作者几乎总能找到将功能分解为一系列小改动的方法。

在编写大型CL之前，请考虑在重构CL之前是否可以为更清晰的实现铺平道路。与你的队友交谈，看看是否有人想过如何在小型CL中实现这些功能。

如果所有这些选项都失败了（这应该是非常罕见的），那么请事先征得审核人员的同意，以便审核大型CL，以便他们收到有关即将发生的事情的警告。在这种情况下，期望在很长一段时间内完成审核过程，对不引入错误保持警惕，并且在编写测试时要特别勤奋。

下一篇：[如何处理审稿人评论]()